{% extends "base.html" %}

{% block title %}é€‰æ‹©é¡¹ç›® - åˆ·é¢˜ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="projects-page">
    <header class="page-header">
        <h1>ğŸ“š é€‰æ‹©ç»ƒä¹ é¡¹ç›®</h1>
        <a href="{{ url_for('logout') }}" class="btn btn-outline">é€€å‡º</a>
    </header>
    
    <div class="projects-container">
        <!-- æ–‡ä»¶å¤¹ä¸­çš„é¡¹ç›® -->
        {% for folder_name, folder_projects in folders.items() %}
        <div class="folder-section">
            <div class="folder-header" onclick="toggleFolder(this)">
                <div class="folder-info">
                    <span class="folder-icon">ğŸ“</span>
                    <h2 class="folder-title">{{ folder_name }}</h2>
                    <span class="folder-count">({{ folder_projects|length }} ä¸ªç»ƒä¹ )</span>
                </div>
                <span class="folder-toggle">â–¼</span>
            </div>
            
            <div class="folder-content">
                <div class="projects-grid">
                    {% for project in folder_projects %}
                    <div class="project-card">
                        <h3 class="project-title">{{ project.display_name }}</h3>
                        <div class="project-stats">
                            <span class="stat">å…± <strong>{{ project.total }}</strong> é¢˜</span>
                            <span class="stat">å·²ç­” <strong>{{ project.answered }}</strong> é¢˜</span>
                            <span class="stat">æ­£ç¡® <strong>{{ project.correct }}</strong> é¢˜</span>
                        </div>
                        
                        {% if project.total > 0 %}
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ (project.answered / project.total * 100)|round(1) }}%"></div>
                        </div>
                        <span class="progress-text">{{ (project.answered / project.total * 100)|round(1) }}%</span>
                        {% endif %}
                        
                        <div class="project-actions">
                            <a href="{{ url_for('practice', project_name=project.id, mode='memorize') }}" class="btn btn-secondary">
                                ğŸ“– èƒŒé¢˜æ¨¡å¼
                            </a>
                            <a href="{{ url_for('practice', project_name=project.id, mode='sequential') }}" class="btn btn-primary">
                                ğŸ“ é¡ºåºç»ƒä¹ 
                            </a>
                            <a href="{{ url_for('practice', project_name=project.id, mode='random') }}" class="btn btn-accent">
                                ğŸ² éšæœºç»ƒä¹ 
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
        
        <!-- ç‹¬ç«‹é¡¹ç›®ï¼ˆä¸åœ¨æ–‡ä»¶å¤¹ä¸­ï¼‰ -->
        {% if standalone_projects %}
        <div class="standalone-section">
            <div class="projects-grid">
                {% for project in standalone_projects %}
                <div class="project-card">
                    <h3 class="project-title">{{ project.display_name }}</h3>
                    <div class="project-stats">
                        <span class="stat">å…± <strong>{{ project.total }}</strong> é¢˜</span>
                        <span class="stat">å·²ç­” <strong>{{ project.answered }}</strong> é¢˜</span>
                        <span class="stat">æ­£ç¡® <strong>{{ project.correct }}</strong> é¢˜</span>
                    </div>
                    
                    {% if project.total > 0 %}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ (project.answered / project.total * 100)|round(1) }}%"></div>
                    </div>
                    <span class="progress-text">{{ (project.answered / project.total * 100)|round(1) }}%</span>
                    {% endif %}
                    
                    <div class="project-actions">
                        <a href="{{ url_for('practice', project_name=project.id, mode='memorize') }}" class="btn btn-secondary">
                            ğŸ“– èƒŒé¢˜æ¨¡å¼
                        </a>
                        <a href="{{ url_for('practice', project_name=project.id, mode='sequential') }}" class="btn btn-primary">
                            ğŸ“ é¡ºåºç»ƒä¹ 
                        </a>
                        <a href="{{ url_for('practice', project_name=project.id, mode='random') }}" class="btn btn-accent">
                            ğŸ² éšæœºç»ƒä¹ 
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if not folders and not standalone_projects %}
        <div class="empty-state">
            <p>æš‚æ— å¯ç”¨çš„ç»ƒä¹ é¡¹ç›®</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// æ–‡ä»¶å¤¹å±•å¼€çŠ¶æ€ç®¡ç†ï¼ˆä½¿ç”¨localStorageï¼Œä¸å¢åŠ æœåŠ¡å™¨è´Ÿè½½ï¼‰
const STORAGE_KEY = 'folder_collapse_state';

// åŠ è½½ä¿å­˜çš„æŠ˜å çŠ¶æ€
function loadFolderStates() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? JSON.parse(saved) : {};
    } catch (e) {
        return {};
    }
}

// ä¿å­˜æŠ˜å çŠ¶æ€
function saveFolderState(folderName, isCollapsed) {
    try {
        const states = loadFolderStates();
        states[folderName] = isCollapsed;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(states));
    } catch (e) {
        console.warn('æ— æ³•ä¿å­˜æ–‡ä»¶å¤¹çŠ¶æ€', e);
    }
}

// åˆ‡æ¢æ–‡ä»¶å¤¹å±•å¼€/æŠ˜å 
function toggleFolder(header) {
    const section = header.parentElement;
    const folderName = header.querySelector('.folder-title').textContent.trim();
    
    section.classList.toggle('collapsed');
    const isCollapsed = section.classList.contains('collapsed');
    
    // ä¿å­˜çŠ¶æ€
    saveFolderState(folderName, isCollapsed);
}

// é¡µé¢åŠ è½½æ—¶æ¢å¤æŠ˜å çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    const states = loadFolderStates();
    
    document.querySelectorAll('.folder-section').forEach(section => {
        const folderName = section.querySelector('.folder-title').textContent.trim();
        
        // å¦‚æœä¹‹å‰ä¿å­˜è¿‡çŠ¶æ€ï¼Œæ¢å¤å®ƒï¼›å¦åˆ™é»˜è®¤å±•å¼€
        if (states[folderName] === true) {
            section.classList.add('collapsed');
        }
    });
});
</script>
{% endblock %}
