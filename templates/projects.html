{% extends "base.html" %}

{% block title %}é€‰æ‹©é¡¹ç›® - åˆ·é¢˜ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="projects-page">
    <header class="page-header">
        <h1>ğŸ“š é€‰æ‹©ç»ƒä¹ é¡¹ç›®</h1>
        <div class="header-actions">
            <button onclick="showAllAnnouncements()" class="btn btn-outline" id="viewAnnouncementsBtn">
                ğŸ“¢ æŸ¥çœ‹å…¬å‘Š
            </button>
            <a href="{{ url_for('logout') }}" class="btn btn-outline">é€€å‡º</a>
        </div>
    </header>
    
    <div class="projects-container">
        <!-- æ–‡ä»¶å¤¹ä¸­çš„é¡¹ç›® -->
        {% for folder_name, folder_projects in folders.items() %}
        <div class="folder-section">
            <div class="folder-header" onclick="toggleFolder(this)">
                <div class="folder-info">
                    <span class="folder-icon">ğŸ“</span>
                    <h2 class="folder-title">{{ folder_name }}</h2>
                    <span class="folder-count">({{ folder_projects|length }} ä¸ªç»ƒä¹ )</span>
                </div>
                <span class="folder-toggle">â–¼</span>
            </div>
            
            <div class="folder-content">
                <div class="projects-grid">
                    {% for project in folder_projects %}
                    <div class="project-card">
                        <h3 class="project-title">{{ project.display_name }}</h3>
                        <div class="project-stats">
                            <span class="stat">å…± <strong>{{ project.total }}</strong> é¢˜</span>
                            <span class="stat">å·²ç­” <strong>{{ project.answered }}</strong> é¢˜</span>
                            <span class="stat">æ­£ç¡® <strong>{{ project.correct }}</strong> é¢˜</span>
                        </div>
                        
                        {% if project.total > 0 %}
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ (project.answered / project.total * 100)|round(1) }}%"></div>
                        </div>
                        <span class="progress-text">{{ (project.answered / project.total * 100)|round(1) }}%</span>
                        {% endif %}
                        
                        <div class="project-actions">
                            <a href="{{ url_for('practice', project_name=project.id, mode='memorize') }}" class="btn btn-secondary">
                                ğŸ“– èƒŒé¢˜æ¨¡å¼
                            </a>
                            <a href="{{ url_for('practice', project_name=project.id, mode='sequential') }}" class="btn btn-primary">
                                ğŸ“ é¡ºåºç»ƒä¹ 
                            </a>
                            <a href="{{ url_for('practice', project_name=project.id, mode='random') }}" class="btn btn-accent">
                                ğŸ² éšæœºç»ƒä¹ 
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
        
        <!-- ç‹¬ç«‹é¡¹ç›®ï¼ˆä¸åœ¨æ–‡ä»¶å¤¹ä¸­ï¼‰ -->
        {% if standalone_projects %}
        <div class="standalone-section">
            <div class="projects-grid">
                {% for project in standalone_projects %}
                <div class="project-card">
                    <h3 class="project-title">{{ project.display_name }}</h3>
                    <div class="project-stats">
                        <span class="stat">å…± <strong>{{ project.total }}</strong> é¢˜</span>
                        <span class="stat">å·²ç­” <strong>{{ project.answered }}</strong> é¢˜</span>
                        <span class="stat">æ­£ç¡® <strong>{{ project.correct }}</strong> é¢˜</span>
                    </div>
                    
                    {% if project.total > 0 %}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ (project.answered / project.total * 100)|round(1) }}%"></div>
                    </div>
                    <span class="progress-text">{{ (project.answered / project.total * 100)|round(1) }}%</span>
                    {% endif %}
                    
                    <div class="project-actions">
                        <a href="{{ url_for('practice', project_name=project.id, mode='memorize') }}" class="btn btn-secondary">
                            ğŸ“– èƒŒé¢˜æ¨¡å¼
                        </a>
                        <a href="{{ url_for('practice', project_name=project.id, mode='sequential') }}" class="btn btn-primary">
                            ğŸ“ é¡ºåºç»ƒä¹ 
                        </a>
                        <a href="{{ url_for('practice', project_name=project.id, mode='random') }}" class="btn btn-accent">
                            ğŸ² éšæœºç»ƒä¹ 
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if not folders and not standalone_projects %}
        <div class="empty-state">
            <p>æš‚æ— å¯ç”¨çš„ç»ƒä¹ é¡¹ç›®</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- å…¬å‘Šæ¨¡æ€æ¡† -->
<div id="announcementModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">ğŸ“¢ ç³»ç»Ÿå…¬å‘Š</h3>
            <button class="modal-close" onclick="closeAnnouncementModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- å…¬å‘Šå†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
        </div>
        <div class="modal-footer" id="modalFooter">
            <button class="btn btn-primary" onclick="closeAnnouncementModal()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div>

<script>
// ==================== æ–‡ä»¶å¤¹å±•å¼€çŠ¶æ€ç®¡ç† ====================
const STORAGE_KEY = 'folder_collapse_state';

// åŠ è½½ä¿å­˜çš„æŠ˜å çŠ¶æ€
function loadFolderStates() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? JSON.parse(saved) : {};
    } catch (e) {
        return {};
    }
}

// ä¿å­˜æŠ˜å çŠ¶æ€
function saveFolderState(folderName, isCollapsed) {
    try {
        const states = loadFolderStates();
        states[folderName] = isCollapsed;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(states));
    } catch (e) {
        console.warn('æ— æ³•ä¿å­˜æ–‡ä»¶å¤¹çŠ¶æ€', e);
    }
}

// åˆ‡æ¢æ–‡ä»¶å¤¹å±•å¼€/æŠ˜å 
function toggleFolder(header) {
    const section = header.parentElement;
    const folderName = header.querySelector('.folder-title').textContent.trim();
    
    section.classList.toggle('collapsed');
    const isCollapsed = section.classList.contains('collapsed');
    
    // ä¿å­˜çŠ¶æ€
    saveFolderState(folderName, isCollapsed);
}

// ==================== å…¬å‘ŠåŠŸèƒ½ ====================
let currentUnreadAnnouncements = [];
let currentAnnouncementIndex = 0;

// è·å–æœªè¯»å…¬å‘Š
async function checkUnreadAnnouncements() {
    try {
        const response = await fetch('/api/get_unread_announcements');
        const data = await response.json();
        
        if (data.success && data.announcements.length > 0) {
            currentUnreadAnnouncements = data.announcements;
            currentAnnouncementIndex = 0;
            showNextUnreadAnnouncement();
        }
    } catch (error) {
        console.error('è·å–æœªè¯»å…¬å‘Šå¤±è´¥:', error);
    }
}

// æ˜¾ç¤ºä¸‹ä¸€æ¡æœªè¯»å…¬å‘Š
function showNextUnreadAnnouncement() {
    if (currentAnnouncementIndex < currentUnreadAnnouncements.length) {
        const announcement = currentUnreadAnnouncements[currentAnnouncementIndex];
        showAnnouncementModal(announcement, true);
    }
}

// æ˜¾ç¤ºå…¬å‘Šæ¨¡æ€æ¡†
function showAnnouncementModal(announcement, isUnread = false) {
    const modal = document.getElementById('announcementModal');
    const modalBody = document.getElementById('modalBody');
    const modalFooter = document.getElementById('modalFooter');
    
    // å¡«å……å†…å®¹
    modalBody.innerHTML = `
        <div class="announcement-detail">
            <h4 class="announcement-modal-title">${announcement.title}</h4>
            <p class="announcement-modal-time">${announcement.timestamp.substring(0, 19).replace('T', ' ')}</p>
            <div class="announcement-modal-content">${announcement.content.replace(/\n/g, '<br>')}</div>
        </div>
    `;
    
    // è®¾ç½®æŒ‰é’®
    if (isUnread) {
        modalFooter.innerHTML = `
            <button class="btn btn-primary" onclick="markAsReadAndNext('${announcement.hash}')">æˆ‘çŸ¥é“äº†</button>
        `;
    } else {
        modalFooter.innerHTML = `
            <button class="btn btn-primary" onclick="closeAnnouncementModal()">å…³é—­</button>
        `;
    }
    
    modal.style.display = 'block';
}

// æ ‡è®°ä¸ºå·²è¯»å¹¶æ˜¾ç¤ºä¸‹ä¸€æ¡
async function markAsReadAndNext(hash) {
    try {
        await fetch('/api/mark_announcement_read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hash: hash })
        });
        
        currentAnnouncementIndex++;
        
        if (currentAnnouncementIndex < currentUnreadAnnouncements.length) {
            showNextUnreadAnnouncement();
        } else {
            closeAnnouncementModal();
        }
    } catch (error) {
        console.error('æ ‡è®°å…¬å‘Šå·²è¯»å¤±è´¥:', error);
        closeAnnouncementModal();
    }
}

// å…³é—­å…¬å‘Šæ¨¡æ€æ¡†
function closeAnnouncementModal() {
    const modal = document.getElementById('announcementModal');
    modal.style.display = 'none';
}

// æŸ¥çœ‹æ‰€æœ‰å…¬å‘Š
async function showAllAnnouncements() {
    try {
        const response = await fetch('/api/get_all_announcements');
        const data = await response.json();
        
        if (data.success) {
            const announcements = data.announcements;
            const modal = document.getElementById('announcementModal');
            const modalBody = document.getElementById('modalBody');
            const modalFooter = document.getElementById('modalFooter');
            
            if (announcements.length === 0) {
                modalBody.innerHTML = '<p class="empty-text">æš‚æ— å…¬å‘Š</p>';
            } else {
                let html = '<div class="all-announcements">';
                for (const ann of announcements) {
                    const readBadge = ann.is_read ? '<span class="read-badge">å·²è¯»</span>' : '<span class="unread-badge">æœªè¯»</span>';
                    html += `
                        <div class="announcement-detail ${ann.is_read ? 'read' : 'unread'}">
                            <div class="announcement-modal-header">
                                <h4 class="announcement-modal-title">${ann.title}</h4>
                                ${readBadge}
                            </div>
                            <p class="announcement-modal-time">${ann.timestamp.substring(0, 19).replace('T', ' ')}</p>
                            <div class="announcement-modal-content">${ann.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                }
                html += '</div>';
                modalBody.innerHTML = html;
            }
            
            modalFooter.innerHTML = `
                <button class="btn btn-primary" onclick="closeAnnouncementModal()">å…³é—­</button>
            `;
            
            modal.style.display = 'block';
        }
    } catch (error) {
        console.error('è·å–å…¬å‘Šåˆ—è¡¨å¤±è´¥:', error);
    }
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.onclick = function(event) {
    const modal = document.getElementById('announcementModal');
    if (event.target === modal) {
        closeAnnouncementModal();
    }
}

// ==================== é¡µé¢åŠ è½½åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', function() {
    // æ¢å¤æ–‡ä»¶å¤¹æŠ˜å çŠ¶æ€
    const states = loadFolderStates();
    document.querySelectorAll('.folder-section').forEach(section => {
        const folderName = section.querySelector('.folder-title').textContent.trim();
        if (states[folderName] === true) {
            section.classList.add('collapsed');
        }
    });
    
    // æ£€æŸ¥æœªè¯»å…¬å‘Š
    checkUnreadAnnouncements();
});
</script>
{% endblock %}
